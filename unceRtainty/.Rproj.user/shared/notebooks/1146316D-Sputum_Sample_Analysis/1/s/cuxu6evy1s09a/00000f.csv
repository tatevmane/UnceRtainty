"0","# Drop rows where Test column contains ""Organism Isolated"""
"0","df <- df %>%"
"0","  filter(!str_detect(Test, ""Organism Isolated""))"
"0",""
"0","# Convert DST_result column to lowercase"
"0","df <- df %>%"
"0","  mutate(DST_result = tolower(DST_result))"
"0",""
"0","# Convert 'none' to NA in the DST_result column"
"0","df <- df %>%"
"0","  mutate(DST_result = ifelse(DST_result == ""none"", NA, DST_result))"
"0",""
"0","# Function to extract and normalize antibiotics"
"0","extract_antibiotics <- function(dst_column) {"
"0","  if (!is.na(dst_column)) {"
"0","    # Split on comma or comma followed by a space"
"0","    antibiotics <- unlist(strsplit(dst_column, "",\\s*""))"
"0","    antibiotics <- trimws(tolower(antibiotics))  # Convert to lowercase"
"0","    antibiotics <- antibiotics[antibiotics != """"] # Remove any empty antibiotic names"
"0","    return(unique(antibiotics))"
"0","  } else {"
"0","    return(character(0))"
"0","  }"
"0","}"
"0",""
"0","# Define criteria for antibiotics"
"0","criteria <- c("
"0","  ""Resistant to"" = 1,"
"0","  ""Intermediate to"" = 2,"
"0","  ""Sensitive to"" = 3"
"0",")"
"0",""
"0","# Function to map criteria to resistance types based on Word column"
"0","map_to_criteria <- function(word_column) {"
"0","  word_column <- tolower(word_column)"
"0","  ifelse(str_detect(word_column, ""resistant""), 1,"
"0","         ifelse(str_detect(word_column, ""intermediate""), 2,"
"0","                ifelse(str_detect(word_column, ""sensitive""), 3, 0)))"
"0","}"
"0",""
"0","# Map criteria to resistance types based on Word column"
"0","df <- df %>%"
"0","  mutate(Test = map_to_criteria(Test))"
"0",""
"0","# Get unique antibiotics"
"0","unique_antibiotics <- df %>%"
"0","  filter(Test != 0) %>%"
"0","  pull(DST_result) %>%"
"0","  map(extract_antibiotics) %>%"
"0","  unlist() %>%"
"0","  unique() %>%"
"0","  sort()"
"0",""
"0","# Create antibiotic columns, ensuring no empty names are created"
"0","for (antibiotic in unique_antibiotics) {"
"0","  if (antibiotic != """") {"
"0","    df[[antibiotic]] <- 0"
"0","  }"
"0","}"
"0",""
"0","# Fill antibiotic columns based on criteria"
"0","fill_antibiotics <- function(df, unique_antibiotics) {"
"0","  for (i in 1:nrow(df)) {"
"0","    if (df$Test[i] != 0) {"
"0","      antibiotics <- extract_antibiotics(df$DST_result[i])"
"0","      for (antibiotic in antibiotics) {"
"0","        df[i, antibiotic] <- df$Test[i]"
"0","      }"
"0","    }"
"0","  }"
"0","  return(df)"
"0","}"
"0",""
"0","# Fill antibiotic columns"
"0","df <- fill_antibiotics(df, unique_antibiotics)"
"0",""
"0","# Drop the Test column"
"0","df <- df %>%"
"0","  select(-Test)"
"0",""
"0","# Aggregate to one row per patient"
"0","df_long <- df %>%"
"0","  group_by(PID, Patient, Sex, Age, `Sample_collection_date`, Year, Bacterial_isolate, Sample_type, Stain_result) %>%"
"0","  summarize(across(all_of(unique_antibiotics), ~ max(.x, na.rm = TRUE)), .groups = 'drop')"
